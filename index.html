<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <title>webvim</title>
    <link type="" rel="stylesheet" href="dist/style.min.css" />

    <link rel="icon" href="favicon.ico?v=4" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.0.10/css/all.css"
      integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg"
      crossorigin="anonymous"
    >
  </head>
  <body>
    <script type="text/javascript" src="dist/elm.js"></script>
    <script type="text/javascript">
      const lineHeight = 23;
const getBuffers = () => {
  const bufs = sessionStorage.getItem('buffers')
  if (bufs) {
    return Object.values(JSON.parse(bufs)).reduce((result, buf) => {
      result[buf.path] = buf;
      return result;
    }, {});
  }
  return {};
}

const buffers = getBuffers();
let activeBuffer = sessionStorage.getItem('activeBuffer');

const restoreBuffer = (path) => {
  return Object.assign({
    path,
    cursor: [0, 0],
    scrollTop : 0,
    content: null,
  }, buffers[path]);
};


const host = location.hostname || 'localhost';
let scheme = '';
if (!location.hostname) {
  scheme = 'http:';
}

const flags = {
  lineHeight,
  service: `${scheme}//${host}:8080`,
  syntaxService: `${scheme}//${host}:8765`,
  buffer: activeBuffer,
};
const app = Elm.Main.fullscreen(flags);

const applyCss = url => {
  const link = document.createElement('link');
  link.rel = "stylesheet";
  link.href = url;
  document.head.appendChild(link);
};

applyCss(`${flags.syntaxService}/css`);

app.ports.saveBuffer.subscribe((buf) => {
  buffers[buf.path] = buf;
});

app.ports.setTitle.subscribe(title => {
  document.title = title;
});

app.ports.getBuffer.subscribe((path) => {
  const buf = restoreBuffer(path);
  buffers[path] = buf;
  app.ports.restoreBuffer.send(buf);
  activeBuffer = path;
});

let debouncers = {};
app.ports.debounce.subscribe(({ action, time, payload }) => {
  const data = debouncers[action] || {};
  
  // console.log('debounce', action);
  if (payload !== undefined) {
    const payloads = data.payloads || [];
    payloads.push(payload);
    data.payloads = payloads;
  }

  clearTimeout(data.timer);
  data.timer = setTimeout(() => {
    // console.log('send debounced', action);
    app.ports.onDebounce.send({
      action,
      payloads: debouncers[action].payloads || [],
    });
    debouncers[action].payloads = null;
  }, time);

  debouncers[action] = data;
});

window.onbeforeunload = () => {
  sessionStorage.setItem('buffers', JSON.stringify(Object.values(buffers)));
  if (activeBuffer) {
    sessionStorage.setItem('activeBuffer', activeBuffer);
  }
};

    </script>
  </body>
</html>
